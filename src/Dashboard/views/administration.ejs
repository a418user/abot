<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include('partials/header.ejs'); %>

    <title>Administration - <%=bot.username%></title>
</head>

<body>
    <!-- Notifications Start -->
    <%- include('partials/notifications/notifications.ejs') %>
    <!-- Notifications End -->

    <%- include('partials/components/navbar.ejs'); %>

    <div id="wrapper">
        <%- include('partials/components/zoneLeft.ejs'); %>

        <%- include('partials/components/zoneProfileParameters.ejs'); %>

        <div id="right-zone">
            <div class="title-container">
                <span class="title-text">Administration</span>
            </div>

            <div class="subtitle-container">
                Statistiques :
            </div>

            <div id="content-container">
                <div class="box">
                    <div class="box-canvas">
                        <canvas id="commandsPerDay"></canvas>
                    </div>
                </div>
                <div class="box">
                    <div class="box-canvas">
                        <canvas id="serversPerDay"></canvas>
                    </div>
                </div>
            </div>

            <div id="content-container">
                <div class="box">
                    <div class="box-canvas">
                        <canvas id="feedback"></canvas>
                    </div>
                </div>
                <div class="box">
                    <div class="box-canvas">
                        <canvas id="globalServers"></canvas>
                    </div>
                </div>
            </div>

            <div class="subtitle-container title-container">
                Gestion du bot :
            </div>

            <div id="content-container">
                <div class="box-inner">
                    <ul class="menu-items">
                        <li class="menu-item">
                            <form action="/administration/bot/stop" method="post">
                                <button type="submit" class="button button-red">
                                    <i class="fa-solid fa-circle-exclamation"></i>
                                    Arrêter le bot
                                </button>
                            </form>
                        </li>
                        <li class="menu-item">
                            <form action="/administration/bot/restart" method="post">
                                <button type="submit" class="button button-blurple">
                                    <i class="fa-solid fa-circle-info"></i>
                                    Redémarrer le bot
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="subtitle-container title-container">
                Gestion des serveurs :
            </div>

            <div id="content-container">
                <div class="box-inner">
                    <ul class="menu-items">
                        <form action="/administration/servers/leave" method="post" class="form-admin">
                            <li class="menu-item">
                                <input
                                        placeholder="Identifiant du serveur"
                                        type="text"
                                        name="serverId"
                                        id="serverId"
                                        class="server-input"
                                        required>
                            </li>
                            <li class="menu-item">
                                <button type="button" onclick="showInvite()" class="button button-blurple">
                                    <i class="fa-solid fa-paper-plane"></i>
                                    Inviter
                                </button>
                            </li>
                            <li class="menu-item">
                                <button type="button" onclick="showInformation()" class="button button-blue">
                                    <i class="fa-solid fa-circle-info"></i>
                                    Information
                                </button>
                            </li>
                            <li class="menu-item">
                                <button type="submit" class="button button-red">
                                    <i class="fa-solid fa-screwdriver-wrench"></i>
                                    Expulser
                                </button>
                            </li>
                        </form>
                    </ul>
                </div>
            </div>

            <div class="subtitle-container title-container">
                Anti-Ban :
            </div>

            <div id="content-container">
                <div class="box-inner">
                    <ul class="menu-items">
                        <form method="post" class="form-admin">
                            <li class="menu-item">
                                <input
                                        placeholder="Identifiant du membre"
                                        type="text"
                                        name="userId"
                                        id="userId"
                                        class="server-input">
                            </li>
                            <li class="menu-item">
                                <button type="submit" formaction="/administration/antiban/add" class="button button-blurple">
                                    <i class="fa-solid fa-plus"></i>
                                    Ajouter
                                </button>
                            </li>
                            <li class="menu-item">
                                <button type="button" onclick="showAntiBan()" class="button button-blue">
                                    <i class="fa-solid fa-circle-info"></i>
                                    Afficher
                                </button>
                            </li>
                            <li class="menu-item">
                                <button type="submit" formaction="/administration/antiban/delete" class="button button-red">
                                    <i class="fa-solid fa-minus"></i>
                                    Supprimer
                                </button>
                            </li>
                        </form>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="showAntiBan" id="displayAntiBan">
        <div class="modal-container">
            <div class="modal">
                <button class="modal-close-button" onclick="closeAntiBan()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-title">Liste des membres protégés</span>
                    </div>
                    <div id="list" class="modal-body"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="showInvite" id="displayInvite">
        <div class="modal-container">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-title">Informations</span>
                        <button class="modal-close-button" onclick="closeInvite()">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div id="invite" class="modal-body"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="showInformation" id="displayInformation">
        <div class="modal-container">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-title">Informations</span>
                        <button class="modal-close-button" onclick="closeInformation()">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div id="information" class="modal-body"></div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    const openMenu = document.getElementById('leftZoneButton');
    const profileZone = document.getElementById('profile-zone');

    openMenu.addEventListener('click', () => {
        profileZone.classList.toggle('desktop-only');
    });
</script>
<script>
    function closeAntiBan() {
        const element = document.getElementById('displayAntiBan');

        if (element.style.display === "block") {
            element.style.display = 'none';
        }
    }

    function closeInvite() {
        const element = document.getElementById('displayInvite');

        if (element.style.display === "block") {
            element.style.display = 'none';
        }
    }

    function closeInformation() {
        const element = document.getElementById('displayInformation');

        if (element.style.display === "block") {
            element.style.display = 'none';
        }
    }

    async function showAntiBan() {
        const response = await fetch('/administration/antiban/list', {
            method: 'GET'
        });

        const data = await response.json();

        const element = document.getElementById('displayAntiBan');
        const div = document.getElementById('list');

        div.innerHTML = '';

        const table = document.createElement('table');
        table.className = 'modal-table';

        const thead = document.createElement('thead');
        thead.style.textTransform = 'uppercase';

        const tr = document.createElement('tr');

        const th1 = document.createElement('th');
        th1.className = 'modal-option';
        th1.innerText = 'Membre';

        const th2 = document.createElement('th');
        th2.className = 'modal-option';
        th2.innerText = 'Identifiant';

        tr.appendChild(th1);
        tr.appendChild(th2);
        thead.appendChild(tr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        data.forEach((user) => {
            const tr = document.createElement('tr');
            tr.style.backgroundColor = '#1e293b';

            const td1 = document.createElement('td');
            td1.className = 'modal-option-body';
            td1.innerText = user.username;

            const td2 = document.createElement('td');
            td2.className = 'modal-option-body';
            td2.innerText = user.user_id;

            tr.appendChild(td1);
            tr.appendChild(td2);
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        div.appendChild(table);

        if (element.style.display === "" || element.style.display === "none") {
            element.style.display = 'block';
        }
    }

    async function showInvite() {
        const guildId = document.getElementById('serverId').value;
        if (!guildId) {
            Swal.fire({
                title: "Erreur",
                text: "Veuillez fournir l'identifiant d'un serveur !",
                icon: "error",
                theme: "auto",
                confirmButtonColor: "#00a7b3",
                color: '#ffffff'
            });
            return;
        }

        try {
            const response = await fetch(`/administration/servers/invite/${guildId}`, {
                method: 'GET'
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.alert) {
                    return Swal.fire({
                        title: data.alert.title,
                        text: data.alert.text,
                        icon: data.alert.icon,
                        theme: "auto",
                        confirmButtonColor: "#00a7b3",
                        color: '#ffffff'
                    });
                }
            }

            const element = document.getElementById('displayInvite');
            const div = document.getElementById('invite');

            div.innerHTML = '';

            const table = document.createElement('table');
            table.className = 'modal-table';

            const thead = document.createElement('thead');
            thead.style.textTransform = 'uppercase';

            const tr = document.createElement('tr');

            const th1 = document.createElement('th');
            th1.className = 'modal-option';
            th1.innerText = 'Serveur';

            const th2 = document.createElement('th');
            th2.className = 'modal-option';
            th2.innerText = 'Invite';

            tr.appendChild(th1);
            tr.appendChild(th2);

            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            const trInvite = document.createElement('tr');
            trInvite.style.backgroundColor = '#1e293b';

            const td1 = document.createElement('td');
            td1.className = 'modal-option-body';

            const td2 = document.createElement('td');
            td2.className = 'modal-option-body';

            td1.innerText = data.name;

            const a = document.createElement('a');
            a.style.color = '#ffffff';
            a.style.fontWeight = 'bold';
            a.href = data.invite;
            a.innerText = data.invite;
            a.setAttribute('target', '_blank');

            td2.appendChild(a);

            trInvite.appendChild(td1);
            trInvite.appendChild(td2);

            tbody.appendChild(trInvite);

            table.appendChild(tbody);

            div.appendChild(table);

            if (element.style.display === "" || element.style.display === "none") {
                element.style.display = 'block';
            }
        }
        catch(error) {
            console.error("Erreur lors de la requête AJAX:", error);
            Swal.fire({
                title: "Erreur",
                text: "Une erreur est survenue lors de la requête.",
                icon: "error",
                theme: "auto",
                confirmButtonColor: "#00a7b3",
                color: '#ffffff'
            });
        }
    }

    async function showInformation() {
        const guildId = document.getElementById('serverId').value;
        if (!guildId) {
            Swal.fire({
                title: "Erreur",
                text: "Veuillez fournir l'identifiant d'un serveur !",
                icon: "error",
                theme: "auto",
                confirmButtonColor: "#00a7b3",
                color: '#ffffff'
            });
            return;
        }

        try {
            const response = await fetch(`/administration/servers/information/${guildId}`, {
                method: 'GET'
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.alert) {
                    return Swal.fire({
                        title: data.alert.title,
                        text: data.alert.text,
                        icon: data.alert.icon,
                        theme: "auto",
                        confirmButtonColor: "#00a7b3",
                        color: '#ffffff'
                    });
                }
            }

            const element = document.getElementById('displayInformation');
            const div = document.getElementById('information');

            div.innerHTML = '';

            const table = document.createElement('table');
            table.className = 'modal-table';

            const thead = document.createElement('thead');
            thead.style.textTransform = 'uppercase';

            const tr = document.createElement('tr');

            const th1 = document.createElement('th');
            th1.className = 'modal-option';
            th1.innerText = 'Photo';

            const th2 = document.createElement('th');
            th2.className = 'modal-option';
            th2.innerText = 'Nom';

            const th3 = document.createElement('th');
            th3.className = 'modal-option';
            th3.innerText = 'Identifiant';

            const th4 = document.createElement('th');
            th4.className = 'modal-option';
            th4.innerText = 'Description';

            const th5 = document.createElement('th');
            th5.className = 'modal-option';
            th5.innerText = 'Propriétaire';

            const th6 = document.createElement('th');
            th6.className = 'modal-option';
            th6.innerText = 'Membres';

            tr.appendChild(th1);
            tr.appendChild(th2);
            tr.appendChild(th3);
            tr.appendChild(th4);
            tr.appendChild(th5);
            tr.appendChild(th6);

            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            const trInformation = document.createElement('tr');
            trInformation.style.backgroundColor = '#1e293b';

            const td0 = document.createElement('td');
            td0.className = 'modal-option-body';

            const td1 = document.createElement('td');
            td1.className = 'modal-option-body';

            const td2 = document.createElement('td');
            td2.className = 'modal-option-body';

            const td3 = document.createElement('td');
            td3.className = 'modal-option-body';

            const td4 = document.createElement('td');
            td4.className = 'modal-option-body';

            const td5 = document.createElement('td');
            td5.className = 'modal-option-body';

            // Add an image to the table
            const img = document.createElement('img');
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '50%';
            img.src = data.icon

            td1.innerText = data.name;
            td2.innerText = data.id;
            td3.innerText = data.description;
            td4.innerText = data.owner;
            td5.innerText = data.memberCount;

            td0.appendChild(img);

            trInformation.appendChild(td0);
            trInformation.appendChild(td1);
            trInformation.appendChild(td2);
            trInformation.appendChild(td3);
            trInformation.appendChild(td4);
            trInformation.appendChild(td5);

            tbody.appendChild(trInformation);

            table.appendChild(tbody);

            div.appendChild(table);

            if (element.style.display === "" || element.style.display === "none") {
                element.style.display = 'block';
            }
        }
        catch(error) {
            console.error("Erreur lors de la requête AJAX:", error);
            Swal.fire({
                title: "Erreur",
                text: "Une erreur est survenue lors de la requête.",
                icon: "error",
                theme: "auto",
                confirmButtonColor: "#00a7b3",
                color: '#ffffff'
            });
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    const ctx = document.getElementById('commandsPerDay').getContext('2d');

    const chartCommandsPerDay = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: "rgb(75, 192, 192)",
                borderColor: "rgb(75, 192, 192)"
            }]
        },
        options: {
            maintainAspectRatio: false,
            elements: {
                point: {
                    radius: 5
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#fff'
                    }
                },
                x: {
                    ticks: {
                        color: '#fff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Commandes des 7 derniers jours',
                    color: '#fff'
                }
            }
        }
    });
</script>
<script>
    const socket = io();
    socket.on('cmdPerDay', function(cmd) {
        if (cmd.allDays.length > 7) {
            chartCommandsPerDay.data.labels = cmd.allDays.slice(Math.max(cmd.allDays.length - 7, 1));
            chartCommandsPerDay.data.datasets[0].data = cmd.allCommands.slice(Math.max(cmd.allCommands.length - 7, 1));
        } else {
            chartCommandsPerDay.data.labels = cmd.allDays;
            chartCommandsPerDay.data.datasets[0].data = cmd.allCommands;
        }

        chartCommandsPerDay.update();
    })
</script>

<script>
    const ctx2 = document.getElementById('serversPerDay').getContext('2d');

    const chartServersPerDay = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Nouveaux serveurs',
                data: [],
                backgroundColor: "rgb(75, 192, 192)",
                borderColor: "rgb(75, 192, 192)"
            }, {
                label: 'Serveurs perdus',
                data: [],
                backgroundColor: "rgb(215,10,88)",
                borderColor: "rgb(215,10,88)"
            }]
        },
        options: {
            maintainAspectRatio: false,
            elements: {
                point: {
                    radius: 5
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#fff'
                    }
                },
                x: {
                    ticks: {
                        color: '#fff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Serveurs des 7 derniers jours',
                    color: '#fff'
                }
            }
        }
    });
</script>
<script>
    socket.on('serversPerDay', function(servers) {
        if (servers.allDays.length > 7) {
            chartServersPerDay.data.labels = servers.allDays.slice(Math.max(servers.allDays.length - 7, 1));
            chartServersPerDay.data.datasets[0].data = servers.allServersNew.slice(Math.max(servers.allServersNew.length - 7, 1));
            chartServersPerDay.data.datasets[1].data = servers.allServersLost.slice(Math.max(servers.allServersLost.length - 7, 1));
        } else {
            chartServersPerDay.data.labels = servers.allDays;
            chartServersPerDay.data.datasets[0].data = servers.allServersNew;
            chartServersPerDay.data.datasets[1].data = servers.allServersLost;
        }

        chartServersPerDay.update();
    })
</script>

<script>
    const ctx3 = document.getElementById('feedback').getContext('2d');

    const chartFeedback = new Chart(ctx3, {
        type: 'pie',
        data: {
            labels: [
                'Support du bot',
                'Site web',
                'Top.gg',
                'Disboard',
                'Autres'
            ],
            datasets: [{
                borderWidth: 1,
                label: 'Réponses',
                data: [],
                backgroundColor: [
                    'rgb(6,126,246)',
                    'rgb(136,227,63)',
                    'rgb(246,253,30)',
                    'rgb(232,88,56)',
                    'rgb(144,75,218)'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            maintainAspectRatio: false,
            animation: {
                animateScale: true
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        color: '#fff'
                    }
                },
                title: {
                    display: true,
                    text: 'Retour Feedback',
                    color: '#fff'
                }
            }
        }
    });
</script>
<script>
    socket.on('feedback', function(data) {
        chartFeedback.data.datasets[0].data = data.data;
        chartFeedback.update();
    })
</script>

<script>
    const ctx4 = document.getElementById('globalServers').getContext('2d');

    const chartGlobalServers = new Chart(ctx4, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: "rgb(75, 192, 192)",
                borderColor: "rgb(75, 192, 192)"
            }]
        },
        options: {
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#fff'
                    }
                },
                x: {
                    ticks: {
                        color: '#fff'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Top 10 des serveurs',
                    color: '#fff'
                }
            }
        }
    });
</script>
<script>
    socket.on('globalServers', function(data) {
        chartGlobalServers.data.labels = data.topGuilds.guildName;
        chartGlobalServers.data.datasets[0].data = data.topGuilds.membersCount;
        chartGlobalServers.update();
    })
</script>
</html>